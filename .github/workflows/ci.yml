name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test:
    name: ğŸ§ª Run All Checks with Docker
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§ª Run tests in Docker
        run: |
          docker compose -f docker-compose.ci.yml run --rm ci-test

      - name: ğŸ” Run linting in Docker
        run: |
          docker compose -f docker-compose.ci.yml run --rm ci-lint

      - name: ğŸ”’ Run security checks in Docker
        run: |
          docker compose -f docker-compose.ci.yml run --rm ci-security

  docker-build:
    name: ğŸ³ Docker Build Test
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”¨ Build and test main Docker image
        run: |
          docker compose build web
          docker compose run --rm web python manage.py check --settings=datapulse.test_settings

  notify:
    name: ğŸ“¢ Notify Results
    runs-on: ubuntu-latest
    needs: [test, docker-build]
    if: always()

    steps:
      - name: ğŸ“¢ Notify on success
        if: success()
        run: |
          echo "âœ… All checks passed! Ready for deployment."

      - name: ğŸ“¢ Notify on failure
        if: failure()
        run: |
          echo "âŒ Some checks failed. Please review the logs."
